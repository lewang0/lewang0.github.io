<!doctype html>
<html lang="zh-CN">

<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.98.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MySQL 数据备份和不停机重新搭建主从同步 - 小碼哥</title>
    <meta property="og:title" content="MySQL 数据备份和不停机重新搭建主从同步 - 小碼哥">
    <meta property="og:type" content="article">
    
    <meta property="article:published_time" content=" 2017-06-06T12:15:07&#43;08:00">
    
    
    <meta property="article:modified_time" content=" 2017-06-06T12:15:07&#43;08:00">
    
    <meta name="Keywords" content="IoT, 物联网, 智能硬件，工业互联网方案，智能家居, 智慧工厂, 智慧建筑, Golang, Java, JVM, Python, 树莓派, Linux 玩家，果粉，系统架构，技术管理">
    <meta name="description" content="MySQL 数据备份和不停机重新搭建主从同步">
    
    <meta name="author" content="小碼哥">
    <meta property="og:url" content="//lewang.dev/posts/2017-06-06-xtrabackup/">
    
    <link rel="shortcut icon" href="/favicon.ico">

    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    
    <link rel="icon" sizes="192x192" href="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/favicon-192x192.png">

    
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/favicon-180x180-precomposed.png">

    
    <meta name="msapplication-TileColor" content="#FFFFFF">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/favicon-144x144.png">

    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link rel="stylesheet" href="/css/main.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    

    
    
</head>

<body>
    <header id="header">
    <div class="container clearfix">
    
        <div class="site-name ">
            <a id="logo" href="//lewang.dev/">
                <img src="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/logo-2x.png" alt="小碼哥">
            </a>
        </div>
        <nav id="nav-menu" class="clearfix">
            <a class=""
                href="//lewang.dev/">首页</a>
            
            <a  href="//lewang.dev/archives/"
                title="归档">归档</a>
            
            <a  href="//lewang.dev/about/"
                title="关于">关于</a>
            
        </nav>
    
    </div>
</header>

    <div id="body">
        <div class="container">
            <article class="post">
                <h1 class="post-title">MySQL 数据备份和不停机重新搭建主从同步</h1>
                
                <div class="post-meta">
                    <span>Jun 6, 2017</span>
                    
                    <span>/</span>
                    
                    <span class="meta-category"><a href="//lewang.dev/categories/DevOps">DevOps</a></span>
                    
                    
                    
                </div>
                
                
                <div style="height: 1px; border-top: 1px #eee solid; margin-top: 16px;"></div>
                
                <div class="post-content markdown-body">
                    
                    
                    <blockquote>
                        本文写于 6 个月之前，如果这是一篇关于计算机技术的文章，那本文内容很有可能已经过期了。
                    </blockquote>
                    
                    
                    <h2 id="背景">背景</h2>
<p>目前公司主要服务都是直接使用 MySQL 主服务器，从服务主要给离线数据分析服务使用，由于前期弄得比较简单的粗暴，从服务上还有一两个数据库在做生产使用, 并且从服数据已经不能和主服进行进行同步了，有大量错误，忽略都没有办法进行。此外，主服仅配置了三个核心数据的 binlog，随着业务的变化，其它数据库不能走主从这条路来同步数据，于是希望不停机的情形下重新调整主服配置，记录所有的数据库的 binlog，同时添加新的从服务器来同步数据</p>
<h2 id="方案1">方案1</h2>
<p>MySQL 的主从是通过同步 binlog 日志来实现数据同步的，于是需要想办法把从服数据先于主服同步，记录 binlog 的 pos 值，再配置从服从该 pos 处开始同步，考虑可以使用 mysqldump 导出所有 innodb 数据，使用 rsync 同步所有 myisam 数据文件，然后再开启主从同步。但是目前这种方案不适用，主服不能长时间停机</p>
<h2 id="方案2">方案2</h2>
<p>使用 xtrabackup 来完成目标</p>
<p>主从服务器上都需要安装 xtrabackup（实际使用 xtrabackupex）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>yum install http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm
</span></span><span style="display:flex;"><span>yum install -y percona-xtrabackup-24
</span></span></code></pre></div><h3 id="主服">主服：</h3>
<h4 id="备份数据">备份数据</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 注意数据库名称的转义，例如 - 号是 @002d
</span></span><span style="display:flex;"><span>innobackupex --defaults-file=/etc/my.cnf --socket=/var/lib/mysql/mysql.sock --user=root --password=xxxx  --parallel=2 --databases=&#34;db1 db2&#34; /data/backup/xtrabackup/
</span></span></code></pre></div><h4 id="保持事务一致">保持事务一致</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>innobackupex --apply-log /data/backup/xtrabackup/2017-06-06_13-16-21/
</span></span></code></pre></div><h4 id="同步数据">同步数据</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>rsync -avHz 2017-06-06_13-16-21 sysops@cow:/data/backup
</span></span></code></pre></div><h3 id="从服">从服：</h3>
<p>修改 my.cnf 相关配置，恢复备份数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># 关闭 MySQL Servier 后恢复数据
</span></span><span style="display:flex;"><span>innobackupex --defaults-file=/etc/my.cnf --copy-back /data/backup/2017-06-06_13-16-21
</span></span></code></pre></div><p>修改数据权限</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>chown -R mysql.mysql mysql
</span></span></code></pre></div><p>开启从服，登录 msyql 添加主从配置，并开启同步</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Master 上执行
</span></span><span style="display:flex;"><span>GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;10.23.9.146&#39; IDENTIFIED BY &#39;password&#39;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Slave 上执行
</span></span><span style="display:flex;"><span>[root@bull data]# cat backup/2018-04-26_21-27-31/xtrabackup_binlog_info
</span></span><span style="display:flex;"><span>mysql-bin.000058        103394265
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CHANGE MASTER TO
</span></span><span style="display:flex;"><span>MASTER_HOST=&#39;10.4.25.28&#39;,
</span></span><span style="display:flex;"><span>MASTER_USER=&#39;repl&#39;,
</span></span><span style="display:flex;"><span>MASTER_PASSWORD=&#39;password&#39;,
</span></span><span style="display:flex;"><span>MASTER_PORT=3306,
</span></span><span style="display:flex;"><span>MASTER_LOG_FILE=&#39;mysql-bin.000058&#39;,
</span></span><span style="display:flex;"><span>MASTER_LOG_POS=103394265;
</span></span></code></pre></div><h2 id="检查主从状态">检查主从状态</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>show master status;
</span></span><span style="display:flex;"><span>show slave status\G;
</span></span></code></pre></div><h2 id="参考">参考</h2>
<ul>
<li>[percona-xtrabackup] (<a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html">https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html</a>)</li>
<li>[wsgzao.github.io/post/xtrabackup] (<a href="https://wsgzao.github.io/post/xtrabackup/">https://wsgzao.github.io/post/xtrabackup/</a>)</li>
</ul>

                    <p>(完)</p>
                    
                    <blockquote>
                        <p>本文为原创文章，转载需注明出处，网站 <a href="https://lewang.dev">https://lewang.dev</a>。
                        </p>
                    </blockquote>
                    
                    
                </div>

                
                

<div class="post-archive">
    <h2>相关文章</h2>
    <ul>
        
        <li><a href="/posts/2014-10-16-tuning-nginx/">Nginx 性能调优「译」</a></li>
        
        <li><a href="/posts/2014-05-06-github-pages-dns-settings/">Github Pages 服务的域名设置</a></li>
        
        <li><a href="/posts/2014-03-06-arch-of-website-domain-cdn/">从域名和 CDN 来看网站架构</a></li>
        
        <li><a href="/posts/2014-03-03-building-devenv-by-vagrant/">使用 Vagrant 构建开发环境</a></li>
        
        <li><a href="/posts/2014-03-02-python-on-my-rmbp/">Python on My rMBP</a></li>
        
    </ul>
</div>

                

                
                <div class="post-meta">
                    
                    <h3>标签</h3>
                    <ul class="clearfix">
                        
                        <li><a href="//lewang.dev/tags/MySQL"># MySQL</a></li>
                        
                        <li><a href="//lewang.dev/tags/xtrabackup"># xtrabackup</a></li>
                        
                    </ul>
                    
                </div>
                
            </article>
            
    

    
    
    <div class="post markdown-body">
      <script src="https://utteranc.es/client.js"
            repo= "lewangdev/lewangdev.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        Copyright &copy; 2011-2022 <a href="//lewang.dev/">小碼哥</a>, All
        rights reserved.
        <a href="//lewang.dev/index.xml">订阅 RSS</a>
    </div>
</footer>


<script type="text/javascript">
    window.MathJax = {
        tex2jax: {
            inlineMath: [['$', '$']],
            processEscapes: true
        }
    };
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-12QS222X0Z"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-12QS222X0Z', { 'anonymize_ip': false });
}
</script>







</body>

</html>
