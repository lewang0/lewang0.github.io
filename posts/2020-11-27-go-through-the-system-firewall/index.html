<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>机房不能访问互联网，轻松搞定系统部署 | PaperMod</title>
<meta name="keywords" content="Linux, 部署, 网络拓扑, IoT">
<meta name="description" content="创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。
在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。
在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。
一、面临的问题 在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:
机房服务器无法访问 Internet 可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段 无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力 无法远程进行维护 客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:
网络拓扑图说明:
机房和办公室不在一个网段 机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24 机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面 内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI 二、解决问题的方法 既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:
告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法
在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法
搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢
通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:
办公室中主机可以接入客户网络
客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口
客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度
拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)
通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="https://adityatelange.github.io/hugo-PaperMod/posts/2020-11-27-go-through-the-system-firewall/">
<link crossorigin="anonymous" href="/hugo-PaperMod/assets/css/stylesheet.dc96e9e0118e5e264a03d68b104df6ae869cfb73c61f5f89dd91aeb16b0d8c03.css" integrity="sha256-3Jbp4BGOXiZKA9aLEE32roac&#43;3PGH1&#43;J3ZGusWsNjAM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://adityatelange.github.io/hugo-PaperMod/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://adityatelange.github.io/hugo-PaperMod/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://adityatelange.github.io/hugo-PaperMod/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://adityatelange.github.io/hugo-PaperMod/apple-touch-icon.png">
<link rel="mask-icon" href="https://adityatelange.github.io/hugo-PaperMod/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://adityatelange.github.io/hugo-PaperMod/posts/2020-11-27-go-through-the-system-firewall/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="机房不能访问互联网，轻松搞定系统部署" />
<meta property="og:description" content="创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。
在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。
在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。
一、面临的问题 在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:
机房服务器无法访问 Internet 可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段 无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力 无法远程进行维护 客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:
网络拓扑图说明:
机房和办公室不在一个网段 机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24 机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面 内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI 二、解决问题的方法 既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:
告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法
在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法
搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢
通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:
办公室中主机可以接入客户网络
客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口
客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度
拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)
通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://adityatelange.github.io/hugo-PaperMod/posts/2020-11-27-go-through-the-system-firewall/" /><meta property="og:image" content="https://adityatelange.github.io/hugo-PaperMod/papermod-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-27T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://adityatelange.github.io/hugo-PaperMod/papermod-cover.png"/>

<meta name="twitter:title" content="机房不能访问互联网，轻松搞定系统部署"/>
<meta name="twitter:description" content="创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。
在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。
在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。
一、面临的问题 在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:
机房服务器无法访问 Internet 可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段 无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力 无法远程进行维护 客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:
网络拓扑图说明:
机房和办公室不在一个网段 机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24 机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面 内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI 二、解决问题的方法 既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:
告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法
在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法
搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢
通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:
办公室中主机可以接入客户网络
客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口
客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度
拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)
通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://adityatelange.github.io/hugo-PaperMod/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "机房不能访问互联网，轻松搞定系统部署",
      "item": "https://adityatelange.github.io/hugo-PaperMod/posts/2020-11-27-go-through-the-system-firewall/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "机房不能访问互联网，轻松搞定系统部署",
  "name": "机房不能访问互联网，轻松搞定系统部署",
  "description": "创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。\n在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。\n在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。\n一、面临的问题 在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:\n机房服务器无法访问 Internet 可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段 无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力 无法远程进行维护 客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:\n网络拓扑图说明:\n机房和办公室不在一个网段 机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24 机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面 内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI 二、解决问题的方法 既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:\n告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法\n在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法\n搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢\n通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:\n办公室中主机可以接入客户网络\n客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口\n客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度\n拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)\n通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。",
  "keywords": [
    "Linux", "部署", "网络拓扑", "IoT"
  ],
  "articleBody": "创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。\n在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。\n在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。\n一、面临的问题 在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:\n机房服务器无法访问 Internet 可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段 无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力 无法远程进行维护 客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:\n网络拓扑图说明:\n机房和办公室不在一个网段 机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24 机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面 内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI 二、解决问题的方法 既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:\n告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法\n在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法\n搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢\n通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:\n办公室中主机可以接入客户网络\n客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口\n客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度\n拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)\n通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。\n三、搭建可以访问互联网的部署环境 我们希望使用第 4 个方法来搭建部署的网络环境，通过测试客户的内网环境，几个前置条件都已满足，这样第 4 个方法的搭建过程不需要客户的参与就可以完成。首先要解决的是网络通路问题，我们在客户办公室添加了一台 4G 路由器，添加 4G 路由器之后的网络拓扑图如图:\n部署控制主机连接好 4G 路由器之后，获取到一个 192.168.8.106 的 IP，注意 4G 路由器的网段要与办公室网段不同，例如办公室网段是 192.168.137.0/24 (也就是子网掩码为 255.255.255.0)，4G 路由器的网段为 192.168.8.0/24，也就是说部署控制主机需要有两个网络接口(网卡)：一个接内网，一个接外网（4G 路由器），如果部署控制主机刚好有一个 RJ45 的以太网卡和一个 WiFI 网卡（很多笔记本电脑就是这样），那部署控制主机在硬件上就不需要在添加额外的硬件了。\n关于网络搭建过程中的使用到硬件就讲这些，各位读者可以根据自己的情况选用合适的网络设备，比如 4G 无线网卡，带 4G 模块的工控主机等等，原则上只要能建立一个互联网访问的通道就行了。\n接下来我们再一起探讨一下如果利用开源软件来搭建互联网访问的通道，如图：\n现在解决问题的思路应该更加清晰了：需要在机房服务器和办公室部署控制主机之间建立一个通道。建立通道可以使用的开源软件有不少，相信很多人因为某些原因都或多或少使用过，从我自己长期实际使用的经验来看，frp 和 WireGuard 非常适合用在当前情况下建立通道，gost 也十分容易搭建 HTTP 或者 SOCK5 代理。\n可以用一句话来描述搭建的过程：\n在机房一台服务器上面安装 frp 或 WireGuard 做服务端，在可以连接外网内网的部署控制主机上安装 frp 或 WireGuard 做客户端，并且在部署控制主机上安装 gost 服务启用 HTTP 代理服务，最后在服务器端的修改系统配置，让 yum 和 docker 拉镜像走 HTTP 代理。\n因为部署系统使用 HTTP 代理就够了，这样 frp + gost 的组合可能比 WireGuard + gost 的组合配置起来会更加简单，WireGuard 是一个可以用于 SDWAN 组网的高性能通道软件，本文就不说明如何使用它来搭建，如果对 WireGuard 搭建 SDWAN 感兴趣，可以自行研究一下或者留言私信给我。\n以下使用 frp + gost 来说明具体的搭建过程。\n3.1 准备需要的软件 请根据自己部署控制主机对应的平台下载需要的软件\nfrp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。 Windows x86_64 系统请下载 frp_0.34.3_windows_amd64.zip Linux x86_64 系统请下载 frp_0.34.3_linux_amd64.tar.gz MacOS 系统请下载 frp_0.34.3_darwin_amd64.tar.gz gost 是 GO 语言实现的安全隧道 Windows x86_64 系统请下载 gost-windows-amd64-2.11.1.zip Linux x86_64 系统请下载 gost-linux-amd64-2.11.1.gz MacOS 系统请下载 gost-darwin-amd64-2.11.1.gz 如果部署控制主机是 ARM 或者 MIPS 架构的，需要上面两个软件需要下载对应的版本来安装，在使用上没有任何差异。\n3.2 配置路由和安装软件 frp 和 gost 安装都比较简单，上传到服务器上解压后就就可以了，我们只需要在其中一台机房服务器上安装 frp 作为服务端启动，机房其它服务器不需要安装 frp，总结一下需要进行的安装步骤：\n在部署控制主机上面配置路由，使得部署控制主机可以访问机房网络也可以访问互联网 其中一台机房服务器上安装 frp，作为服务端启动 部署控制主机上安装 gost，启动一个 HTTP 代理服务器 部署控制主机上安装 frp，作为客户端启动 以下部署过程以部署控制主机系统为 MacOS，机房服务器系统为 CentOS 7.6 为例，如果读者在实际部署过程中由于系统与本文不同而遇到问题不知如何解决，比如服务器为 Ubuntu，部署机是 Windows 10，欢迎留言一起探讨。\n在部署控制主机上面配置路由 如果部署控制主机和机房服务器在同一个子网，则不需要添加路由。由于本次部署控制主机和机房服务器不在一个子网，在接了两个网卡之后，在部署控制主机上的 IP 包是不知道如何路由到机房网络的，如果不做路由设置，172.22.0.0/16 网段会走系统默认的路由，可能无法访问到机房网络。所以在部署控制主机上（ MacOS 系统）添加以下路由:\nsudo route add -net 172.22.0.0/16 192.168.137.1 如果部署控制主机为 Linux 或者 Windows 也需要手动添加路由。\n在机房任意一台服务器上安装 frp 上传 frp_0.34.3_linux_amd64.tar.gz 到服务器，解压 frp_0.34.3_linux_amd64.tar.gz 安装包\n$ tar -zxvf frp_0.34.3_linux_amd64.tar.gz frp_0.34.3_linux_amd64/ frp_0.34.3_linux_amd64/frps_full.ini frp_0.34.3_linux_amd64/frps.ini frp_0.34.3_linux_amd64/frpc frp_0.34.3_linux_amd64/frpc_full.ini frp_0.34.3_linux_amd64/frps frp_0.34.3_linux_amd64/LICENSE frp_0.34.3_linux_amd64/frpc.ini 进入 frp_0.34.3_linux_amd64 目录并新建 frps-deployment.ini 文件，内容为\n[common] bind_port = 7000 找到 frps 命令后启动：\n$ ./frps -c frps-deployment.ini 2020/11/30 06:53:01 [I] [service.go:128] frps tcp listen on 0.0.0.0:7000 2020/11/30 06:53:01 [I] [root.go:190] Start frps success 如果服务无法启动，可能是 7000 端口已经被占用或者是 frps 没有执行权限，请注意具体的报错信息。\n在部署控制主机上安装 gost 解压 gost 包，并且添加执行权限\n$ gunzip gost-darwin-amd64-2.11.1.gz $ chmod +x gost-darwin-amd64-2.11.1 启动 HTTP 代理, 在端口 18080 上监听\n$ ./gost-darwin-amd64-2.11.1 -L http://:18080 在控制主机上安装 frp 解压 frp 安装包后在目录中新建 frpc-deployment.ini 文件，内容为\n[common] server_addr = 192.168.52.79 server_port = 7000 [gost] type = tcp local_ip = 127.0.0.1 local_port = 18080 remote_port = 18080 作为客户端启动 frpc\n$ ./frpc -c frpc-deployment.ini 2020/11/30 14:59:30 [I] [proxy_manager.go:300] proxy removed: [] 2020/11/30 14:59:30 [I] [proxy_manager.go:310] proxy added: [gost] 2020/11/30 14:59:30 [I] [proxy_manager.go:333] visitor removed: [] 2020/11/30 14:59:30 [I] [proxy_manager.go:342] visitor added: [] 2020/11/30 14:59:30 [I] [control.go:246] [f51d0bf5d26ef627] login to server success, get run id [f51d0bf5d26ef627], server udp port [0] 2020/11/30 14:59:30 [I] [control.go:169] [f51d0bf5d26ef627] [gost] start proxy success 至此通道就搭建完成了，如图所示。\n3.3 启用代理 机房服务器使用的都是 CentOS 7.6 的系统，需要用到的 yum 和 docker 也都支持通过 HTTP 代理进行软件包和容器镜像的下载，如果使用的是 ubuntu 系统，通过 apt 也可以配置为通过 HTTP 代理下载软件包，以下还是以 CentOS 7.6 系统为例。\nyum 启用 http 代理 修改 /etc/yum.conf 文件，添加代理配置\nproxy=http://127.0.0.1:18080 我们测试一下代理是否成功\n$ sudo yum makecache Loaded plugins: fastestmirror Loading mirror speeds from cached hostfile epel/x86_64/metalink | 23 kB 00:00:01 * base: mirrors.neusoft.edu.cn * epel: ftp.iij.ad.jp * extras: ftp.sjtu.edu.cn * updates: ftp.sjtu.edu.cn base | 3.6 kB 00:00:00 docker-ce-stable | 3.5 kB 00:00:00 epel | 4.7 kB 00:00:00 extras | 2.9 kB 00:00:00 updates | 2.9 kB 00:00:00 (2/3): epel/x86_64/primary_db 20% [=================== ] 790 kB/s | 4.6 MB 00:00:22 ETA 代理看起来没有问题，我们来安装 git 试试。\n$ sudo yum install -y git Loaded plugins: fastestmirror Loading mirror speeds from cached hostfile * base: mirrors.neusoft.edu.cn * epel: d2lzkl7pfhq30w.cloudfront.net * extras: ftp.sjtu.edu.cn * updates: ftp.sjtu.edu.cn Resolving Dependencies --\u003e Running transaction check ---\u003e Package git.x86_64 0:1.8.3.1-23.el7_8 will be installed --\u003e Processing Dependency: perl-Git = 1.8.3.1-23.el7_8 for package: git-1.8.3.1-23.el7_8.x86_64 --\u003e Processing Dependency: perl(Git) for package: git-1.8.3.1-23.el7_8.x86_64 --\u003e Running transaction check ---\u003e Package perl-Git.noarch 0:1.8.3.1-23.el7_8 will be installed --\u003e Finished Dependency Resolution Dependencies Resolved ============================================================================================================================================================================================================================================ Package Arch Version Repository Size ============================================================================================================================================================================================================================================ Installing: git x86_64 1.8.3.1-23.el7_8 base 4.4 M Installing for dependencies: perl-Git noarch 1.8.3.1-23.el7_8 base 56 k Transaction Summary ============================================================================================================================================================================================================================================ Install 1 Package (+1 Dependent package) Total download size: 4.5 M Installed size: 22 M Downloading packages: (1/2): perl-Git-1.8.3.1-23.el7_8.noarch.rpm | 56 kB 00:00:01 (2/2): git-1.8.3.1-23.el7_8.x86_64.rpm | 4.4 MB 00:00:06 -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- Total 669 kB/s | 4.5 MB 00:00:06 Running transaction check Running transaction test Transaction test succeeded Running transaction Installing : perl-Git-1.8.3.1-23.el7_8.noarch 1/2 Installing : git-1.8.3.1-23.el7_8.x86_64 2/2 Verifying : git-1.8.3.1-23.el7_8.x86_64 1/2 Verifying : perl-Git-1.8.3.1-23.el7_8.noarch 2/2 Installed: git.x86_64 0:1.8.3.1-23.el7_8 Dependency Installed: perl-Git.noarch 0:1.8.3.1-23.el7_8 Complete! 太令人激动了，我们的代理起作用了，接下来可以愉快的安装软件了。\ndocker 启用 http 代理 首先需要通过 yum 安装 docker 服务，关于 docker 的安装本文不再说明，请参考官方文档 Install Docker Engine on CentOS。安装完 docker 服务之后，通过以下步骤来配置 Docker 服务使用 HTTP 代理\n创建目录和文件\nsudo mkdir -p /etc/systemd/system/docker.service.d sudo touch /etc/systemd/system/docker.service.d/http-proxy.conf 添加以下内容到配置文件 http-proxy.conf 中\n[Service] Environment=\"HTTP_PROXY=http://127.0.0.1:18080\" Environment=\"NO_PROXY=localhost,127.0.0.1\" 重启 docker 服务，使得配置生效\nsudo systemctl daemon-reload sudo systemctl restart docker 验证配置\nsudo systemctl show --property=Environment docker Environment=HTTP_PROXY=http://127.0.0.1:18080 NO_PROXY=localhost,127.0.0.1 我们来运行一个 docker 镜像试试\n$ sudo docker run hello-world Unable to find image 'hello-world:latest' locally latest: Pulling from library/hello-world 0e03bdcc26d7: Pull complete Digest: sha256:e7c70bb24b462baa86c102610182e3efcb12a04854e8c582838d92970a09f323 Status: Downloaded newer image for hello-world:latest Hello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \"hello-world\" image from the Docker Hub. (amd64) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ 通过代理拉取 docker 镜像也成功了，这样就可以直接从我们的公网上搭建的 docker registry 服务拉取待部署的镜像，真是太省事了。\n命令行全局启用代理 也可以在 shell 中启用 HTTP 代理，请根据需要启用\n$ export HTTP_PROXY=”http://127.0.0.1:18080” 在机房其它服务器上使用 HTTP 代理 我们是把 frp 安装到 172.22.121.110 这台服务器上并启动了 frps 服务，通过 frp 的穿透，相当于在 172.22.121.110 这台服务器上启动了一个 HTTP 代理，在 172.22.121.110 本机上使用 http://127.0.0.1:18080 来使用 HTTP 代理，在机房其它服务器上则需要使用 http://172.22.121.110:18080 来使用 HTTP 代理。\n四、实验测试环境的搭建 需要 CentOS 7 环境，且虚拟机不能访问外网\n使用 vagrant 启动一个 centos/7 虚拟机，并且使用桥接模式获取局域网 IP, 例如 IP 为 192.168.52.79 在网关路由器上进行配置使得测试的 CentOS 7 虚拟机无法访问互联网，如果网关路由器是个 linux based 的系统则可以尝试用 iptables 限制虚拟机访问互联网: iptables -A FORWARD -s 192.168.52.79 -j DROP 五、远程维护 通过前面关于 frp 的使用，不难看出来，只要在部署控制主机再启动一个 frp 客户端，把机房或者部署控制主机的 SSH 端口映射到到公网中的 frp 服务器可以了。当然这种情况下还在需要多做一些配置工作，比如在部署控制主机上配置好服务的自启动，然后把部署控制主机放在客户的办公室，在需要远程维护的时候，开机就好。\n对于远程维护，使用 frp 可能不太安全，毕竟直接把 SSH 端口暴露在公网之中，所以在这种情况下，推荐使用 WireGuard 进行 SDWAN 组网，把部署控制主机加入到自建的私有网络中。\n",
  "wordCount" : "975",
  "inLanguage": "en",
  "datePublished": "2020-11-27T00:00:00Z",
  "dateModified": "2020-11-27T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://adityatelange.github.io/hugo-PaperMod/posts/2020-11-27-go-through-the-system-firewall/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PaperMod",
    "logo": {
      "@type": "ImageObject",
      "url": "https://adityatelange.github.io/hugo-PaperMod/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://adityatelange.github.io/hugo-PaperMod/" accesskey="h" title="PaperMod (Alt + H)">PaperMod</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://adityatelange.github.io/hugo-PaperMod/fr/" title="French"
                            aria-label=":fr:">🇫🇷</a>
                    </li>
                    <li>
                        <a href="https://adityatelange.github.io/hugo-PaperMod/fa/" title="Fa"
                            aria-label="Fa">Fa</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://adityatelange.github.io/hugo-PaperMod/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://adityatelange.github.io/hugo-PaperMod/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://adityatelange.github.io/hugo-PaperMod/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://discord.gg/ahpmTvhVmp" title="Discord">
                    <span>Discord</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://adityatelange.github.io/hugo-PaperMod/">Home</a>&nbsp;»&nbsp;<a href="https://adityatelange.github.io/hugo-PaperMod/posts/">Posts</a></div>
    <h1 class="post-title">
      机房不能访问互联网，轻松搞定系统部署
    </h1>
    <div class="post-meta"><span title='2020-11-27 00:00:00 +0000 UTC'>November 27, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/2020-11-27-go-through-the-system-firewall.markdown" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%80%e9%9d%a2%e4%b8%b4%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="一、面临的问题">一、面临的问题</a></li>
                <li>
                    <a href="#%e4%ba%8c%e8%a7%a3%e5%86%b3%e9%97%ae%e9%a2%98%e7%9a%84%e6%96%b9%e6%b3%95" aria-label="二、解决问题的方法">二、解决问题的方法</a></li>
                <li>
                    <a href="#%e4%b8%89%e6%90%ad%e5%bb%ba%e5%8f%af%e4%bb%a5%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%e7%9a%84%e9%83%a8%e7%bd%b2%e7%8e%af%e5%a2%83" aria-label="三、搭建可以访问互联网的部署环境">三、搭建可以访问互联网的部署环境</a><ul>
                        
                <li>
                    <a href="#31-%e5%87%86%e5%a4%87%e9%9c%80%e8%a6%81%e7%9a%84%e8%bd%af%e4%bb%b6" aria-label="3.1 准备需要的软件">3.1 准备需要的软件</a></li>
                <li>
                    <a href="#32-%e9%85%8d%e7%bd%ae%e8%b7%af%e7%94%b1%e5%92%8c%e5%ae%89%e8%a3%85%e8%bd%af%e4%bb%b6" aria-label="3.2 配置路由和安装软件">3.2 配置路由和安装软件</a><ul>
                        
                <li>
                    <a href="#%e5%9c%a8%e9%83%a8%e7%bd%b2%e6%8e%a7%e5%88%b6%e4%b8%bb%e6%9c%ba%e4%b8%8a%e9%9d%a2%e9%85%8d%e7%bd%ae%e8%b7%af%e7%94%b1" aria-label="在部署控制主机上面配置路由">在部署控制主机上面配置路由</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%9c%ba%e6%88%bf%e4%bb%bb%e6%84%8f%e4%b8%80%e5%8f%b0%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e5%ae%89%e8%a3%85-frp" aria-label="在机房任意一台服务器上安装 frp">在机房任意一台服务器上安装 frp</a></li>
                <li>
                    <a href="#%e5%9c%a8%e9%83%a8%e7%bd%b2%e6%8e%a7%e5%88%b6%e4%b8%bb%e6%9c%ba%e4%b8%8a%e5%ae%89%e8%a3%85-gost" aria-label="在部署控制主机上安装 gost">在部署控制主机上安装 gost</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%8e%a7%e5%88%b6%e4%b8%bb%e6%9c%ba%e4%b8%8a%e5%ae%89%e8%a3%85-frp" aria-label="在控制主机上安装 frp">在控制主机上安装 frp</a></li></ul>
                </li>
                <li>
                    <a href="#33-%e5%90%af%e7%94%a8%e4%bb%a3%e7%90%86" aria-label="3.3 启用代理">3.3 启用代理</a><ul>
                        
                <li>
                    <a href="#yum-%e5%90%af%e7%94%a8-http-%e4%bb%a3%e7%90%86" aria-label="yum 启用 http 代理">yum 启用 http 代理</a></li>
                <li>
                    <a href="#docker-%e5%90%af%e7%94%a8-http-%e4%bb%a3%e7%90%86" aria-label="docker 启用 http 代理">docker 启用 http 代理</a></li>
                <li>
                    <a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%85%a8%e5%b1%80%e5%90%af%e7%94%a8%e4%bb%a3%e7%90%86" aria-label="命令行全局启用代理">命令行全局启用代理</a></li>
                <li>
                    <a href="#%e5%9c%a8%e6%9c%ba%e6%88%bf%e5%85%b6%e5%ae%83%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e4%bd%bf%e7%94%a8-http-%e4%bb%a3%e7%90%86" aria-label="在机房其它服务器上使用 HTTP 代理">在机房其它服务器上使用 HTTP 代理</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9b%e5%ae%9e%e9%aa%8c%e6%b5%8b%e8%af%95%e7%8e%af%e5%a2%83%e7%9a%84%e6%90%ad%e5%bb%ba" aria-label="四、实验测试环境的搭建">四、实验测试环境的搭建</a></li>
                <li>
                    <a href="#%e4%ba%94%e8%bf%9c%e7%a8%8b%e7%bb%b4%e6%8a%a4" aria-label="五、远程维护">五、远程维护</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>创业这段时间以来，我们的 IoT 系统已经在不少客户的机房做了私有化部署，客户大多都是机加工厂、商业大楼、医院和大学实验室等，客户的机房都有一个相同的特点：私有云，与外网隔离，不能访问互联网。或者更为准确的说，是我们部署的服务器不能访问互联网，在没有互联网访问权限的情况下，系统的包管理工具(yum/apt/docker)都无法使用了，在这种情况下进行系统部署安装，费时费力，而且无法进行远程部署维护，也大大增加了项目的实施成本。</p>
<p>在最近的一个客户项目的实施过程中，看到客户的一些其他供应商在系统部署过程中非常艰难，甚至是 CentOS 系统初始化和 Docker 的安装就花掉了两个礼拜的人力，不排除一些供应商这样折腾会给他的客户留下工作敬业钱花的值的好印象，但对于我们这样的小创业公司来说，这样的时间浪费和低效是无法承担的成本，因为来实操部署的人就是公司老板本人了，我也不想出差在客户这里待上两个礼拜。</p>
<p>在工作完成之后，想想可以把解决问题的方法记录一下，也许能给遇到相同问题的同行一些启发和帮助。好了，废话不多说，接下来我们就来解决这个无外网的部署问题，顺便再解决一下远程维护的问题。</p>
<h2 id="一面临的问题">一、面临的问题<a hidden class="anchor" aria-hidden="true" href="#一面临的问题">#</a></h2>
<p>在部署和维护一个私有化企业内部使用且无互联网访问的系统中，可能会面临以下问题:</p>
<ul>
<li>机房服务器无法访问 Internet</li>
<li>可通过接入企业内网来访问服务器，而从服务器无法直连办公室网络，即机房和办公室在不同的网段</li>
<li>无互联网访问权限的情况下，无法直接使用系统的配置工具，如 yum/apt/docker 等，配置系统和部署服务费时费力</li>
<li>无法远程进行维护</li>
</ul>
<p>客户内网拓扑示意图，此处省略了防火墙，简化拓扑图的复杂度，如下:</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/go-through-the-system-firewall/network-topo-basic.png" alt="network-topo"  />
</p>
<p>网络拓扑图说明:</p>
<ul>
<li>机房和办公室不在一个网段</li>
<li>机房网段假设为 172.22.0.0/16，办公室内网 WiFi 的网段为 192.168.137.0/24</li>
<li>机房服务器之间是互通的，办公室可以 ping 通机房服务器，在机房服务器上无法 ping 通办公室部署控制主机，这里假设办公室网络作为一个 NAT 放在上层交换机后面</li>
<li>内网没有互联网访问权限，包括机房服务器和办公室内网 WiFI</li>
</ul>
<h2 id="二解决问题的方法">二、解决问题的方法<a hidden class="anchor" aria-hidden="true" href="#二解决问题的方法">#</a></h2>
<p>既然是由于机房服务器没有互联网访问权限，不能联网下载安装包，那就想办法让机房服务器可以连接互联网或者搭建内网的软件包镜像服务，于是想到一些方法来达到目的:</p>
<ol>
<li>
<p>告知客户问题，申请开通互联网访问权限，可以限定为指定的网址和协议(HTTP/HTTPS)，需要远程维护的化，还需要申请可以连接到服务器的 VPN。这个方法在需要客户的进行审批，可能时间比较长。我们的客户中有不少都没有自建 VPN，或这不方便给我们开通 VPN，另外也无法开通需要我们部署的服务器的互联网访问权限，所以不能使用这个方法</p>
</li>
<li>
<p>在客户机房放置可以通过 4G 上网的堡垒机，堡垒机接入客户机房网络。在客户机房放一个堡垒机，虽然说是堡垒机，但可能客户那边的机房管理也还是不容许放置这样的机器的，所以也不能使用这个方法</p>
</li>
<li>
<p>搭建 yum(CentOS)/apt(Debian/Ubuntu)/docker 的内网镜像服务，搭建内网镜像服务可能就是一个比较艰巨的任务，难以接受给自己又添加了一个艰难的任务，此方法也作罢</p>
</li>
<li>
<p>通过在办公室网里放置部署控制机，同时连接内网和 4G 路由器提供的外网(互联网)，在部署控制机上搭建 SDWAN 或者 HTTP 代理，yum/apt/docker 都支持 HTTP 代理，这样修改系统配置之后，就可以通过代理安装部署服务，这个方法比较简单，而且几乎不需要客户的参与就可以完成。不过也有一些前置条件，例如:</p>
<ul>
<li>
<p>办公室中主机可以接入客户网络</p>
</li>
<li>
<p>客户服务器允许办公室网络中主机通过 TCP 或者 UDP 访问其任意或者指定的端口</p>
</li>
<li>
<p>客户办公室的 4G 网络信号要足够好，这样可以提供更好的外网速度</p>
</li>
<li>
<p>拥有服务器的 root 管理员权限(需要安装软件和修改系统配置)</p>
</li>
</ul>
</li>
</ol>
<p>通过权衡利弊，我们最终使用的是第 4 个方法来搭建的，下面来讲讲搭建的过程。</p>
<h2 id="三搭建可以访问互联网的部署环境">三、搭建可以访问互联网的部署环境<a hidden class="anchor" aria-hidden="true" href="#三搭建可以访问互联网的部署环境">#</a></h2>
<p>我们希望使用第 4 个方法来搭建部署的网络环境，通过测试客户的内网环境，几个前置条件都已满足，这样第 4 个方法的搭建过程不需要客户的参与就可以完成。首先要解决的是网络通路问题，我们在客户办公室添加了一台 4G 路由器，添加 4G 路由器之后的网络拓扑图如图:</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/go-through-the-system-firewall/network-topo-4g-router.png" alt="network-topo"  />
</p>
<p>部署控制主机连接好 4G 路由器之后，获取到一个 <code>192.168.8.106</code> 的 IP，注意 4G 路由器的网段要与办公室网段不同，例如办公室网段是 192.168.137.0/24 (也就是子网掩码为 255.255.255.0)，4G 路由器的网段为 192.168.8.0/24，也就是说部署控制主机需要有两个网络接口(网卡)：一个接内网，一个接外网（4G 路由器），如果部署控制主机刚好有一个 RJ45 的以太网卡和一个 WiFI 网卡（很多笔记本电脑就是这样），那部署控制主机在硬件上就不需要在添加额外的硬件了。</p>
<p>关于网络搭建过程中的使用到硬件就讲这些，各位读者可以根据自己的情况选用合适的网络设备，比如 4G 无线网卡，带 4G 模块的工控主机等等，原则上只要能建立一个互联网访问的通道就行了。</p>
<p>接下来我们再一起探讨一下如果利用开源软件来搭建互联网访问的通道，如图：</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/go-through-the-system-firewall/network-topo-tunnel.png" alt="network-topo"  />
</p>
<p>现在解决问题的思路应该更加清晰了：需要在机房服务器和办公室部署控制主机之间建立一个通道。建立通道可以使用的开源软件有不少，相信很多人因为某些原因都或多或少使用过，从我自己长期实际使用的经验来看，<a href="https://github.com/fatedier/frp/blob/dev/README_zh.md">frp</a> 和 <a href="https://www.wireguard.com/">WireGuard</a> 非常适合用在当前情况下建立通道，<a href="https://github.com/ginuerzh/gost">gost</a> 也十分容易搭建 HTTP 或者 SOCK5 代理。</p>
<p>可以用一句话来描述搭建的过程：</p>
<p><strong>在机房一台服务器上面安装 frp 或 WireGuard 做服务端，在可以连接外网内网的部署控制主机上安装 frp 或 WireGuard 做客户端，并且在部署控制主机上安装 gost 服务启用 HTTP 代理服务，最后在服务器端的修改系统配置，让 yum 和 docker 拉镜像走 HTTP 代理。</strong></p>
<p>因为部署系统使用 HTTP 代理就够了，这样 frp + gost 的组合可能比 WireGuard + gost 的组合配置起来会更加简单，WireGuard 是一个可以用于 SDWAN 组网的高性能通道软件，本文就不说明如何使用它来搭建，如果对 WireGuard 搭建 SDWAN 感兴趣，可以自行研究一下或者留言私信给我。</p>
<p>以下使用 frp + gost 来说明具体的搭建过程。</p>
<h3 id="31-准备需要的软件">3.1 准备需要的软件<a hidden class="anchor" aria-hidden="true" href="#31-准备需要的软件">#</a></h3>
<p>请根据自己部署控制主机对应的平台下载需要的软件</p>
<ul>
<li><a href="https://github.com/fatedier/frp/releases">frp</a> 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。
<ul>
<li>Windows x86_64 系统请下载 <a href="https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_windows_amd64.zip">frp_0.34.3_windows_amd64.zip</a></li>
<li>Linux x86_64 系统请下载 <a href="https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_linux_amd64.tar.gz">frp_0.34.3_linux_amd64.tar.gz</a></li>
<li>MacOS 系统请下载 <a href="https://github.com/fatedier/frp/releases/download/v0.34.3/frp_0.34.3_darwin_amd64.tar.gz">frp_0.34.3_darwin_amd64.tar.gz</a></li>
</ul>
</li>
<li><a href="https://github.com/ginuerzh/gost/releases">gost</a> 是 GO 语言实现的安全隧道
<ul>
<li>Windows x86_64 系统请下载 <a href="https://github.com/ginuerzh/gost/releases/download/v2.11.1/gost-windows-amd64-2.11.1.zip">gost-windows-amd64-2.11.1.zip</a></li>
<li>Linux x86_64 系统请下载 <a href="https://github.com/ginuerzh/gost/releases/download/v2.11.1/gost-linux-amd64-2.11.1.gz">gost-linux-amd64-2.11.1.gz</a></li>
<li>MacOS 系统请下载 <a href="https://github.com/ginuerzh/gost/releases/download/v2.11.1/gost-darwin-amd64-2.11.1.gz">gost-darwin-amd64-2.11.1.gz</a></li>
</ul>
</li>
</ul>
<p>如果部署控制主机是 ARM 或者 MIPS 架构的，需要上面两个软件需要下载对应的版本来安装，在使用上没有任何差异。</p>
<h3 id="32-配置路由和安装软件">3.2 配置路由和安装软件<a hidden class="anchor" aria-hidden="true" href="#32-配置路由和安装软件">#</a></h3>
<p>frp 和 gost 安装都比较简单，上传到服务器上解压后就就可以了，我们只需要在其中一台机房服务器上安装 frp 作为服务端启动，机房其它服务器不需要安装 frp，总结一下需要进行的安装步骤：</p>
<ol>
<li>在部署控制主机上面配置路由，使得部署控制主机可以访问机房网络也可以访问互联网</li>
<li>其中一台机房服务器上安装 frp，作为服务端启动</li>
<li>部署控制主机上安装 gost，启动一个 HTTP 代理服务器</li>
<li>部署控制主机上安装 frp，作为客户端启动</li>
</ol>
<p>以下部署过程以部署控制主机系统为 MacOS，机房服务器系统为 CentOS 7.6 为例，如果读者在实际部署过程中由于系统与本文不同而遇到问题不知如何解决，比如服务器为 Ubuntu，部署机是 Windows 10，欢迎留言一起探讨。</p>
<h4 id="在部署控制主机上面配置路由">在部署控制主机上面配置路由<a hidden class="anchor" aria-hidden="true" href="#在部署控制主机上面配置路由">#</a></h4>
<p>如果部署控制主机和机房服务器在同一个子网，则不需要添加路由。由于本次部署控制主机和机房服务器不在一个子网，在接了两个网卡之后，在部署控制主机上的 IP 包是不知道如何路由到机房网络的，如果不做路由设置，172.22.0.0/16 网段会走系统默认的路由，可能无法访问到机房网络。所以在部署控制主机上（ MacOS 系统）添加以下路由:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo route add -net 172.22.0.0/16 192.168.137.1
</span></span></code></pre></div><p>如果部署控制主机为 Linux 或者 Windows 也需要手动添加路由。</p>
<h4 id="在机房任意一台服务器上安装-frp">在机房任意一台服务器上安装 frp<a hidden class="anchor" aria-hidden="true" href="#在机房任意一台服务器上安装-frp">#</a></h4>
<p>上传 frp_0.34.3_linux_amd64.tar.gz 到服务器，解压 frp_0.34.3_linux_amd64.tar.gz 安装包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tar -zxvf frp_0.34.3_linux_amd64.tar.gz
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frps_full.ini
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frps.ini
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frpc
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frpc_full.ini
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frps
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/LICENSE
</span></span><span class="line"><span class="cl">frp_0.34.3_linux_amd64/frpc.ini
</span></span></code></pre></div><p>进入 frp_0.34.3_linux_amd64 目录并新建 frps-deployment.ini 文件，内容为</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[common]</span>
</span></span><span class="line"><span class="cl"><span class="na">bind_port</span> <span class="o">=</span> <span class="s">7000</span>
</span></span></code></pre></div><p>找到 frps 命令后启动：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./frps -c frps-deployment.ini
</span></span><span class="line"><span class="cl">2020/11/30 06:53:01 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>service.go:128<span class="o">]</span> frps tcp listen on 0.0.0.0:7000
</span></span><span class="line"><span class="cl">2020/11/30 06:53:01 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>root.go:190<span class="o">]</span> Start frps success
</span></span></code></pre></div><p>如果服务无法启动，可能是 7000 端口已经被占用或者是 frps 没有执行权限，请注意具体的报错信息。</p>
<h4 id="在部署控制主机上安装-gost">在部署控制主机上安装 gost<a hidden class="anchor" aria-hidden="true" href="#在部署控制主机上安装-gost">#</a></h4>
<p>解压 gost 包，并且添加执行权限</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gunzip gost-darwin-amd64-2.11.1.gz
</span></span><span class="line"><span class="cl">$ chmod +x gost-darwin-amd64-2.11.1
</span></span></code></pre></div><p>启动 HTTP 代理, 在端口 18080 上监听</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./gost-darwin-amd64-2.11.1 -L http://:18080
</span></span></code></pre></div><h4 id="在控制主机上安装-frp">在控制主机上安装 frp<a hidden class="anchor" aria-hidden="true" href="#在控制主机上安装-frp">#</a></h4>
<p>解压 frp 安装包后在目录中新建 frpc-deployment.ini 文件，内容为</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[common]</span>
</span></span><span class="line"><span class="cl"><span class="na">server_addr</span> <span class="o">=</span> <span class="s">192.168.52.79</span>
</span></span><span class="line"><span class="cl"><span class="na">server_port</span> <span class="o">=</span> <span class="s">7000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[gost]</span>
</span></span><span class="line"><span class="cl"><span class="na">type</span> <span class="o">=</span> <span class="s">tcp</span>
</span></span><span class="line"><span class="cl"><span class="na">local_ip</span> <span class="o">=</span> <span class="s">127.0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="na">local_port</span> <span class="o">=</span> <span class="s">18080</span>
</span></span><span class="line"><span class="cl"><span class="na">remote_port</span> <span class="o">=</span> <span class="s">18080</span>
</span></span></code></pre></div><p>作为客户端启动 frpc</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./frpc -c frpc-deployment.ini
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>proxy_manager.go:300<span class="o">]</span> proxy removed: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>proxy_manager.go:310<span class="o">]</span> proxy added: <span class="o">[</span>gost<span class="o">]</span>
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>proxy_manager.go:333<span class="o">]</span> visitor removed: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>proxy_manager.go:342<span class="o">]</span> visitor added: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>control.go:246<span class="o">]</span> <span class="o">[</span>f51d0bf5d26ef627<span class="o">]</span> login to server success, get run id <span class="o">[</span>f51d0bf5d26ef627<span class="o">]</span>, server udp port <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">2020/11/30 14:59:30 <span class="o">[</span>I<span class="o">]</span> <span class="o">[</span>control.go:169<span class="o">]</span> <span class="o">[</span>f51d0bf5d26ef627<span class="o">]</span> <span class="o">[</span>gost<span class="o">]</span> start proxy success
</span></span></code></pre></div><p>至此通道就搭建完成了，如图所示。</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/lewangdev/picb0/main/oh-my-blog/go-through-the-system-firewall/network-topo-tunnel-proxy.png" alt="network-topo"  />
</p>
<h3 id="33-启用代理">3.3 启用代理<a hidden class="anchor" aria-hidden="true" href="#33-启用代理">#</a></h3>
<p>机房服务器使用的都是 CentOS 7.6 的系统，需要用到的 yum 和 docker 也都支持通过 HTTP 代理进行软件包和容器镜像的下载，如果使用的是 ubuntu 系统，通过 apt 也可以配置为通过 HTTP 代理下载软件包，以下还是以 CentOS 7.6 系统为例。</p>
<h4 id="yum-启用-http-代理">yum 启用 http 代理<a hidden class="anchor" aria-hidden="true" href="#yum-启用-http-代理">#</a></h4>
<p>修改 <code>/etc/yum.conf</code> 文件，添加代理配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">proxy</span><span class="o">=</span><span class="s">http://127.0.0.1:18080</span>
</span></span></code></pre></div><p>我们测试一下代理是否成功</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo yum makecache
</span></span><span class="line"><span class="cl">Loaded plugins: fastestmirror
</span></span><span class="line"><span class="cl">Loading mirror speeds from cached hostfile
</span></span><span class="line"><span class="cl">epel/x86_64/metalink                                                                                                                                                                                                 <span class="p">|</span>  <span class="m">23</span> kB  00:00:01
</span></span><span class="line"><span class="cl"> * base: mirrors.neusoft.edu.cn
</span></span><span class="line"><span class="cl"> * epel: ftp.iij.ad.jp
</span></span><span class="line"><span class="cl"> * extras: ftp.sjtu.edu.cn
</span></span><span class="line"><span class="cl"> * updates: ftp.sjtu.edu.cn
</span></span><span class="line"><span class="cl">base                                                                                                                                                                                                                 <span class="p">|</span> 3.6 kB  00:00:00
</span></span><span class="line"><span class="cl">docker-ce-stable                                                                                                                                                                                                     <span class="p">|</span> 3.5 kB  00:00:00
</span></span><span class="line"><span class="cl">epel                                                                                                                                                                                                                 <span class="p">|</span> 4.7 kB  00:00:00
</span></span><span class="line"><span class="cl">extras                                                                                                                                                                                                               <span class="p">|</span> 2.9 kB  00:00:00
</span></span><span class="line"><span class="cl">updates                                                                                                                                                                                                              <span class="p">|</span> 2.9 kB  00:00:00
</span></span><span class="line"><span class="cl"><span class="o">(</span>2/3<span class="o">)</span>: epel/x86_64/primary_db                                                                           20% <span class="o">[===================</span>                                                                          <span class="o">]</span> <span class="m">790</span> kB/s <span class="p">|</span> 4.6 MB  00:00:22 ETA
</span></span></code></pre></div><p>代理看起来没有问题，我们来安装 git 试试。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo yum install -y git
</span></span><span class="line"><span class="cl">Loaded plugins: fastestmirror
</span></span><span class="line"><span class="cl">Loading mirror speeds from cached hostfile
</span></span><span class="line"><span class="cl"> * base: mirrors.neusoft.edu.cn
</span></span><span class="line"><span class="cl"> * epel: d2lzkl7pfhq30w.cloudfront.net
</span></span><span class="line"><span class="cl"> * extras: ftp.sjtu.edu.cn
</span></span><span class="line"><span class="cl"> * updates: ftp.sjtu.edu.cn
</span></span><span class="line"><span class="cl">Resolving Dependencies
</span></span><span class="line"><span class="cl">--&gt; Running transaction check
</span></span><span class="line"><span class="cl">---&gt; Package git.x86_64 0:1.8.3.1-23.el7_8 will be installed
</span></span><span class="line"><span class="cl">--&gt; Processing Dependency: perl-Git <span class="o">=</span> 1.8.3.1-23.el7_8 <span class="k">for</span> package: git-1.8.3.1-23.el7_8.x86_64
</span></span><span class="line"><span class="cl">--&gt; Processing Dependency: perl<span class="o">(</span>Git<span class="o">)</span> <span class="k">for</span> package: git-1.8.3.1-23.el7_8.x86_64
</span></span><span class="line"><span class="cl">--&gt; Running transaction check
</span></span><span class="line"><span class="cl">---&gt; Package perl-Git.noarch 0:1.8.3.1-23.el7_8 will be installed
</span></span><span class="line"><span class="cl">--&gt; Finished Dependency Resolution
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Dependencies <span class="nv">Resolved</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">============================================================================================================================================================================================================================================</span>
</span></span><span class="line"><span class="cl"> Package                                                 Arch                                                  Version                                                            Repository                                           <span class="nv">Size</span>
</span></span><span class="line"><span class="cl"><span class="o">============================================================================================================================================================================================================================================</span>
</span></span><span class="line"><span class="cl">Installing:
</span></span><span class="line"><span class="cl"> git                                                     x86_64                                                1.8.3.1-23.el7_8                                                   base                                                4.4 M
</span></span><span class="line"><span class="cl">Installing <span class="k">for</span> dependencies:
</span></span><span class="line"><span class="cl"> perl-Git                                                noarch                                                1.8.3.1-23.el7_8                                                   base                                                 <span class="m">56</span> k
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Transaction <span class="nv">Summary</span>
</span></span><span class="line"><span class="cl"><span class="o">============================================================================================================================================================================================================================================</span>
</span></span><span class="line"><span class="cl">Install  <span class="m">1</span> Package <span class="o">(</span>+1 Dependent package<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total download size: 4.5 M
</span></span><span class="line"><span class="cl">Installed size: <span class="m">22</span> M
</span></span><span class="line"><span class="cl">Downloading packages:
</span></span><span class="line"><span class="cl"><span class="o">(</span>1/2<span class="o">)</span>: perl-Git-1.8.3.1-23.el7_8.noarch.rpm                                                                                                                                                                          <span class="p">|</span>  <span class="m">56</span> kB  00:00:01
</span></span><span class="line"><span class="cl"><span class="o">(</span>2/2<span class="o">)</span>: git-1.8.3.1-23.el7_8.x86_64.rpm                                                                                                                                                                               <span class="p">|</span> 4.4 MB  00:00:06
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Total                                                                                                                                                                                                       <span class="m">669</span> kB/s <span class="p">|</span> 4.5 MB  00:00:06
</span></span><span class="line"><span class="cl">Running transaction check
</span></span><span class="line"><span class="cl">Running transaction <span class="nb">test</span>
</span></span><span class="line"><span class="cl">Transaction <span class="nb">test</span> succeeded
</span></span><span class="line"><span class="cl">Running transaction
</span></span><span class="line"><span class="cl">  Installing : perl-Git-1.8.3.1-23.el7_8.noarch                                                                                                                                                                                         1/2
</span></span><span class="line"><span class="cl">  Installing : git-1.8.3.1-23.el7_8.x86_64                                                                                                                                                                                              2/2
</span></span><span class="line"><span class="cl">  Verifying  : git-1.8.3.1-23.el7_8.x86_64                                                                                                                                                                                              1/2
</span></span><span class="line"><span class="cl">  Verifying  : perl-Git-1.8.3.1-23.el7_8.noarch                                                                                                                                                                                         2/2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Installed:
</span></span><span class="line"><span class="cl">  git.x86_64 0:1.8.3.1-23.el7_8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Dependency Installed:
</span></span><span class="line"><span class="cl">  perl-Git.noarch 0:1.8.3.1-23.el7_8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Complete!
</span></span></code></pre></div><p>太令人激动了，我们的代理起作用了，接下来可以愉快的安装软件了。</p>
<h4 id="docker-启用-http-代理">docker 启用 http 代理<a hidden class="anchor" aria-hidden="true" href="#docker-启用-http-代理">#</a></h4>
<p>首先需要通过 yum 安装 docker 服务，关于 docker 的安装本文不再说明，请参考官方文档 <a href="https://docs.docker.com/engine/install/centos/">Install Docker Engine on CentOS</a>。安装完 docker 服务之后，通过以下步骤来配置<a href="https://docs.docker.com/config/daemon/systemd/"> Docker 服务使用 HTTP 代理</a></p>
<p>创建目录和文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo mkdir -p /etc/systemd/system/docker.service.d
</span></span><span class="line"><span class="cl">sudo touch /etc/systemd/system/docker.service.d/http-proxy.conf
</span></span></code></pre></div><p>添加以下内容到配置文件 http-proxy.conf 中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[Service]</span>
</span></span><span class="line"><span class="cl"><span class="na">Environment</span><span class="o">=</span><span class="s">&#34;HTTP_PROXY=http://127.0.0.1:18080&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">Environment</span><span class="o">=</span><span class="s">&#34;NO_PROXY=localhost,127.0.0.1&#34;</span>
</span></span></code></pre></div><p>重启 docker 服务，使得配置生效</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl restart docker
</span></span></code></pre></div><p>验证配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl show --property<span class="o">=</span>Environment docker
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">Environment</span><span class="o">=</span><span class="nv">HTTP_PROXY</span><span class="o">=</span>http://127.0.0.1:18080 <span class="nv">NO_PROXY</span><span class="o">=</span>localhost,127.0.0.1
</span></span></code></pre></div><p>我们来运行一个 docker 镜像试试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo docker run hello-world
</span></span><span class="line"><span class="cl">Unable to find image <span class="s1">&#39;hello-world:latest&#39;</span> locally
</span></span><span class="line"><span class="cl">latest: Pulling from library/hello-world
</span></span><span class="line"><span class="cl">0e03bdcc26d7: Pull <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">Digest: sha256:e7c70bb24b462baa86c102610182e3efcb12a04854e8c582838d92970a09f323
</span></span><span class="line"><span class="cl">Status: Downloaded newer image <span class="k">for</span> hello-world:latest
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hello from Docker!
</span></span><span class="line"><span class="cl">This message shows that your installation appears to be working correctly.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To generate this message, Docker took the following steps:
</span></span><span class="line"><span class="cl"> 1. The Docker client contacted the Docker daemon.
</span></span><span class="line"><span class="cl"> 2. The Docker daemon pulled the <span class="s2">&#34;hello-world&#34;</span> image from the Docker Hub.
</span></span><span class="line"><span class="cl">    <span class="o">(</span>amd64<span class="o">)</span>
</span></span><span class="line"><span class="cl"> 3. The Docker daemon created a new container from that image which runs the
</span></span><span class="line"><span class="cl">    executable that produces the output you are currently reading.
</span></span><span class="line"><span class="cl"> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span></span><span class="line"><span class="cl">    to your terminal.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To try something more ambitious, you can run an Ubuntu container with:
</span></span><span class="line"><span class="cl"> $ docker run -it ubuntu bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Share images, automate workflows, and more with a free Docker ID:
</span></span><span class="line"><span class="cl"> https://hub.docker.com/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For more examples and ideas, visit:
</span></span><span class="line"><span class="cl"> https://docs.docker.com/get-started/
</span></span></code></pre></div><p>通过代理拉取 docker 镜像也成功了，这样就可以直接从我们的公网上搭建的 docker registry 服务拉取待部署的镜像，真是太省事了。</p>
<h4 id="命令行全局启用代理">命令行全局启用代理<a hidden class="anchor" aria-hidden="true" href="#命令行全局启用代理">#</a></h4>
<p>也可以在 shell 中启用 HTTP 代理，请根据需要启用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">HTTP_PROXY</span><span class="o">=</span>”http://127.0.0.1:18080”
</span></span></code></pre></div><h4 id="在机房其它服务器上使用-http-代理">在机房其它服务器上使用 HTTP 代理<a hidden class="anchor" aria-hidden="true" href="#在机房其它服务器上使用-http-代理">#</a></h4>
<p>我们是把 frp 安装到 172.22.121.110 这台服务器上并启动了 frps 服务，通过 frp 的穿透，相当于在 172.22.121.110 这台服务器上启动了一个 HTTP 代理，在 172.22.121.110 本机上使用 http://127.0.0.1:18080 来使用 HTTP 代理，在机房其它服务器上则需要使用 http://172.22.121.110:18080 来使用 HTTP 代理。</p>
<h2 id="四实验测试环境的搭建">四、实验测试环境的搭建<a hidden class="anchor" aria-hidden="true" href="#四实验测试环境的搭建">#</a></h2>
<p>需要 CentOS 7 环境，且虚拟机不能访问外网</p>
<ul>
<li>使用 vagrant 启动一个 centos/7 虚拟机，并且使用桥接模式获取局域网 IP, 例如 IP 为 192.168.52.79</li>
<li>在网关路由器上进行配置使得测试的 CentOS 7 虚拟机无法访问互联网，如果网关路由器是个 linux based 的系统则可以尝试用 iptables 限制虚拟机访问互联网: <code>iptables -A FORWARD -s 192.168.52.79 -j DROP</code></li>
</ul>
<h2 id="五远程维护">五、远程维护<a hidden class="anchor" aria-hidden="true" href="#五远程维护">#</a></h2>
<p>通过前面关于 frp 的使用，不难看出来，只要在部署控制主机再启动一个 frp 客户端，把机房或者部署控制主机的 SSH 端口映射到到公网中的 frp 服务器可以了。当然这种情况下还在需要多做一些配置工作，比如在部署控制主机上配置好服务的自启动，然后把部署控制主机放在客户的办公室，在需要远程维护的时候，开机就好。</p>
<p>对于远程维护，使用 frp 可能不太安全，毕竟直接把 SSH 端口暴露在公网之中，所以在这种情况下，推荐使用 WireGuard 进行 SDWAN 组网，把部署控制主机加入到自建的私有网络中。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://adityatelange.github.io/hugo-PaperMod/tags/linux/">Linux</a></li>
      <li><a href="https://adityatelange.github.io/hugo-PaperMod/tags/%E9%83%A8%E7%BD%B2/">部署</a></li>
      <li><a href="https://adityatelange.github.io/hugo-PaperMod/tags/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91/">网络拓扑</a></li>
      <li><a href="https://adityatelange.github.io/hugo-PaperMod/tags/iot/">IoT</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://adityatelange.github.io/hugo-PaperMod/posts/2020-12-02-add-gost-plugin-for-shadowsocks-ng/">
    <span class="title">« Prev</span>
    <br>
    <span>写了一个 ShadowsocksX-NG 的 gost 插件</span>
  </a>
  <a class="next" href="https://adityatelange.github.io/hugo-PaperMod/posts/2020-02-22-hello-gradle-1/">
    <span class="title">Next »</span>
    <br>
    <span>大象（Gradle）的故事：一见如故</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on twitter"
        href="https://twitter.com/intent/tweet/?text=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2&amp;url=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f&amp;hashtags=Linux%2c%e9%83%a8%e7%bd%b2%2c%e7%bd%91%e7%bb%9c%e6%8b%93%e6%89%91%2cIoT">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f&amp;title=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2&amp;summary=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2&amp;source=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f&title=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on whatsapp"
        href="https://api.whatsapp.com/send?text=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%20-%20https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share 机房不能访问互联网，轻松搞定系统部署 on telegram"
        href="https://telegram.me/share/url?text=%e6%9c%ba%e6%88%bf%e4%b8%8d%e8%83%bd%e8%ae%bf%e9%97%ae%e4%ba%92%e8%81%94%e7%bd%91%ef%bc%8c%e8%bd%bb%e6%9d%be%e6%90%9e%e5%ae%9a%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2&amp;url=https%3a%2f%2fadityatelange.github.io%2fhugo-PaperMod%2fposts%2f2020-11-27-go-through-the-system-firewall%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://adityatelange.github.io/hugo-PaperMod/">PaperMod</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
